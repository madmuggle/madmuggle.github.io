# Vi和其他工具的协同
2017/01/19 10:11:00


## Vi和命令行工具

传统的Vi编辑器没有像Vim一样，提供类似Vimscript的插件语言，但是这并不代表传统Vi无法与第三方命令协同，因为Vi有强大灵活的`!`命令。


## 基本用法

基本用法很简单，就跟其他命令行指令一样，敲入`:`，然后敲入`!`，接下来的事，就和在shell中使用命令一样。

举个例子，我在文件编辑到一半的时候，忘记了这个目录还有哪些文件，比起保存退出，查看后重新打开文件，更方便的做法是：

```
:!ls
```

然后你就看到了`ls`命令的输出。再按一次回车就会自动回到刚才的编辑界面。


## 配合range

上面的用法虽能带来一点方便，但总体感觉用处不大。可是一旦配合上range，即指定操作范围（行），`!`就能派上大用场了。

range后的`!`，其作用是：把指定行的内容作为命令的stdin，读取命令的stdout来替换指定行。

比如当你运行：

```
:. !ls
```

光标所在行的内容，会被替换成当前目录的文件列表。

这有什么用呢？用处大了！

比如你想查看当前文件的十六进制模式，Vim可能有插件实现了这个功能，但这种做法不够灵活。如果你打算自己实现，还得去学习Vimscript。

Unix下有个叫`xxd`的命令可以进行十六进制查看，Vi可以用上它，只需要：

```
:. !xxd
```

现在光标所在行的内容变成了十六进制的显示方式。如果你想看整个文件的十六进制显示，可以：

```
:1,$ !xxd
```

或者更简单的写法：

```
:% !xxd
```

如果需要恢复原来的内容，可以用`u`撤销，还可以运行下面这个命令，让`xxd`来完成这个工作：

```
:% !xxd -r
```

一个更常用的地方是代码格式化。拿Javascript为例，格式化JS代码的命令行工具有很多，比如[js-beautify][js-beautify]，可以通过下面的命令安装这个工具：

```sh
npm install -g js-beautify
```

然后在Vi编辑器里面，你可以这样格式化JS代码：

```
:% !js-beautify -t
```


## 优点

这种做法最大的好处在于，当你想自己扩展功能，可以使用任何熟悉的语言来编写命令行工具，并配合Vi使用，不需要学习编辑器特有的嵌入语言。

这种方法的灵活性不是简单一个插件系统能够企及的。


## 适用范围

所有的Vi变种应该都支持这种用法，我在最原始的[Unix Vi][ex]和最常见的Vim上都做过测试，确保可行。

nvi和elvis等变体跟原始vi保持着兼容，我想也是可行的，但没有实际测试。


[ex]: https://downloads.sourceforge.net/project/ex-vi/ex-vi/050325/ex-050325.tar.bz2
[js-beautify]: https://www.npmjs.com/package/js-beautify

