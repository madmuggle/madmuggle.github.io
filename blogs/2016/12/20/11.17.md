# 简单的文件上传服务器（Node.js版）



## 简单又麻烦的文件传送

电脑和手机间传文件，方法虽多，却少有方便通用的。Windows或者Mac用户可以使用QQ等工具，这类软件普及率之高仅次于浏览器。对于Linux用户，这些方便基本享受不到。

FTP之类的工具在功能上自然是满足的，但是手机内置软件里面默认不包含FTP相关工具。安装来历不明的第三方APP是个麻烦且有风险的事情。

好在程序员是可以自己创造工具的。


## HTTP传文件

用HTTP传文件是非常棒的选择，因为作为客户端，浏览器的普及率世界第一，并且是真正的跨平台。我们只要在电脑上运行起自己的服务程序，基本就能从任何设备往电脑传文件了。

以前学习各种Web框架的时候，首先要做的就是写一个简单的文件上传服务器，因为这有实际用途的程序，写着比较有意思。

我的硬盘里能找到基于Tornado，Bottle，Flask，Servlet等等实现同样功能的程序。甚至还有一个C写的。手动处理`multipart`的麻烦程度，现在依然记忆犹新。


## Node.js版本的程序

刚才写了个Node.js版本的，没有使用`express`或`koa`之类的Web框架，而是直接使用内置模块`http`。唯一的外部依赖是`busboy`，为了对付`multipart`。

这样相当于Python直接使用WSGI，Ruby直接使用Rack。乍看上去似乎是回到了石器时代，但事实并非如此，对于某些情况，这种做法反而让程序更简单了。

比如我这个[程序][github]，包含HTML模版在内也只有几十行。因为不需要处理路由，不需要支持插件，所以“裸奔”其实更合适。

在Web这件事上，Node.js的确有它的独到之处。


## Template literals

我认为"Template literals"是ES6里，除“箭头函数”之外最好的东西。它在日常使用中给我们带来很多方便，并且特定情况下可以取代模版引擎。

为了显示已经上传过的文件列表，我把首页做成动态页面。其中拼接列表没有像往常一样用ejs，而是尝试直接使用"Template literals"。

```js
`<ul>${ files.map(f => `<li>${f}</li>`).join('') }</ul>`
```

我觉得这种写法非常棒，在更简洁的同时，还避免了第三方库的使用。乍一看还有点像JSX。

当然这个解决不了复杂的模版，因为复杂的模版需要组件化，模块化，相互包含…… 对于这种情况，恐怕还是用传统的模版引擎比较合适。

但写程序本来就是个权衡各种因素的过程，Template literals是一个不错的选择。


## 关于302

传送完文件之后，需要从POST重定向到GET。直接返回主页面内容更容易，但用户在这种状态下刷新页面会比较麻烦。所以返回302/303状态，让浏览器主动发一次GET请求比较合适。

但是我发现直接像这样返回一个302是不行的，浏览器是无法完成重定向：

```js
res.writeHead(302)
```

虽然我的服务程序不管PATH，但是浏览器不是这样的。如果在服务器的Response里面没有发现`Location`这个HTTP头，浏览器就不会发起新的请求。

所以必须在Response里给出`Location`字段：

```js
res.writeHead(302, { 'Location': '/' })
```

由于这个应用并没有处理Path，所以你可以给任何路径，比如

```js
res.writeHead(302, { 'Location': '/blah/blah' })
```

地址栏上的显示会变化，但对这个应用没有任何影响。


[github]: https://github.com/madmuggle/FileUpload
